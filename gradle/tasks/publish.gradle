apply plugin: 'signing'
apply plugin: 'maven-publish'

signing {
    required { gradle.taskGraph.hasTask('publish') }
    sign configurations.archives
}

ext {
    sonatypeUser = project.hasProperty('sonatypeUser') ? project.getProperty('sonatypeUser') : ''
    sonatypePassword = project.hasProperty('sonatypePassword') ? project.getProperty('sonatypePassword') : ''
}

tasks.withType(Javadoc) {
    // FIXME: Fix errors rather than supressing them
    failOnError = false
}

tasks.withType(Jar) {
    from(project.projectDir) {
        include "${rootDir}/LICENSE"
        into 'META-INF'
    }
}

task sourceJar(type: Jar, dependsOn: classes) {
    classifier 'sources'
    from sourceSets.main.allSource
}

task javadocJar(type: Jar, dependsOn: javadoc) {
    classifier = 'javadoc'
    from javadoc.destinationDir
}

publishing {
    publications {
        maven(MavenPublication) {
            from components.java

            artifact sourceJar
            artifact javadocJar

            pom.withXml {
                asNode().with {
                    appendNode('description', 'Enterprise open source portal built by and for the higher education community.')
                    appendNode('url', 'https://www.apereo.org/projects/uportal')
                    appendNode('scm').with {
                        appendNode('url', 'https://github.com/Jasig/uPortal')
                        appendNode('connection', 'scm:git@github.com:Jasig/uPortal.git')
                    }
                    appendNode('issueManagement').with {
                        appendNode('url', 'https://issues.jasig.org/browse/UP/')
                        appendNode('system', 'JIRA')
                    }
                    appendNode('licenses').with {
                        appendNode('license').with {
                            appendNode('name', 'The Apache Software License, Version 2.0')
                            appendNode('url', 'http://www.apache.org/licenses/LICENSE-2.0.txt')
                        }
                    }
                    appendNode('organization').with {
                        appendNode('name', 'Apereo')
                        appendNode('url', 'https://www.apereo.org/')
                    }
                    appendNode('developers').with {
                        appendNode('developer').with {
                            appendNode('organization', 'uPortal Developers')
                            appendNode('organizationUrl', 'https://github.com/Jasig/uPortal/graphs/contributors')
                        }
                    }
                }
            }
        }
    }
    repositories {
        maven {
            // Sonatype staging repo for releases
            url 'https://oss.sonatype.org/service/local/staging/deploy/maven2/'
            credentials {
                username sonatypeUser
                password sonatypePassword
            }
        }
    }
}
