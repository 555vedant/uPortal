<project name="uPortal-ear" basedir="." xmlns:up="urn:up-util-ant" xmlns:artifact="urn:maven-artifact-ant">
    <typedef resource="org/apache/maven/artifact/ant/antlib.xml" uri="urn:maven-artifact-ant">
        <classpath>
            <pathelement location="${basedir}/../bootstrap/maven-ant-tasks-2.0.7.jar" />
        </classpath>
    </typedef>
    
    <taskdef resource="net/sf/antcontrib/antcontrib.properties">
        <classpath>
            <pathelement location="${basedir}/../bootstrap/ant-contrib-1.0b3.jar" />
        </classpath>
    </taskdef>

    <target name="assemblePortlets" description="Runs the Cernunnos deployer on WARs in the staging directory and in the EAR. All packaged files are updated and ready to deploy as is after running this task">
        <property name="targetDir" value="${basedir}/target" />
        <property name="assembleDir" value="${targetDir}/pluto-assembly" />
        <mkdir dir="${assembleDir}" />

        <antcall target="assembleWars">
            <param name="warDir" value="${targetDir}/${maven.final.name}" />
            <param name="assembleDir" value="${assembleDir}" />
        </antcall>

        <antcall target="assembleArchive">
            <param name="file" value="${targetDir}/${maven.final.name}.ear" />
            <param name="assembleDir" value="${assembleDir}" />
        </antcall>
        
        <delete dir="${assembleDir}" />
    </target>

    <target name="assembleWars">
        <foreach target="assembleArchive" param="file">
            <path>
                <fileset dir="${warDir}">
                    <include name="*.war" />
                </fileset>
            </path>
            
            <param name="assembleDir" value="${assembleDir}" />
        </foreach>
    </target>

    <target name="assembleArchive" depends="setup-assembler">
        <basename property="fileName" file="${file}" />
        
        <assemblePortlet destdir="${assembleDir}" war="${file}" />
        <move file="${assembleDir}/${fileName}" tofile="${file}" overwrite="true" />
    </target>

    <target name="setup-assembler">
        <artifact:dependencies pathid="pluto-ant" verbose="false">
            <pom file="${basedir}/../bootstrap/pluto-assembler-pom.xml" />
        </artifact:dependencies>

        <taskdef classname="org.apache.pluto.ant.AssembleTask" name="assemblePortlet">
            <classpath>
                <path refid="pluto-ant" />
            </classpath>
        </taskdef>
    </target>
</project>
