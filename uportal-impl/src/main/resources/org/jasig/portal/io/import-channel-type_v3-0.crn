<!--

    Copyright (c) 2000-2009, Jasig, Inc.
    See license distributed with this file and available online at
    https://www.ja-sig.org/svn/jasig-parent/tags/rel-10/license-header.txt

-->
<!--
 | NOTICE:  This file represents a contractual API that is leveraged by more 
 | than one caller.  Please do not refactor this file in a way that changes 
 | the number or nature of arguments expected.
 |
 | These are:
 |   - ${Attributes.NODE}=XML Element that defines the entity to import
 |   - ${PORTAL_CONTEXT}=uPortal's Spring ApplicationContext
 |   - ${SqlAttributes.DATA_SOURCE}=the DataSource for the PortalDb
 |   - ${SqlAttributes.TRANSACTION_MANAGER}=PlatformTransactionManager in use
 |   - Settings defined in classpath://properties/db/entities/import.properties
 |
 +-->
<with-attribute key="CHANNEL_TYPE" value="${valueOf(type)}">
    <groovy>
        <!-- 
         | We want to be sure that the specified Java class (i.e. ${valueOf(type)}) is 
         | present in the classpath.  This implementation will yield a simple stack 
         | trace if the test fails. 
         +-->
        <script>Class.forName(CHANNEL_TYPE);</script>
        <subtasks>
            <sql-transaction>
                <sql-upsert>
                    <update-statement>
                        UPDATE up_chan_type 
                        SET type = ?, type_descr = ?, type_def_uri = ? 
                        WHERE type_name = ?
                    </update-statement>
                    <insert-statement>
                        INSERT INTO up_chan_type(type, type_descr, type_def_uri, type_name, type_id) 
                        VALUES(?, ?, ?, ?, ?)
                    </insert-statement>
                    
                    <update-parameter value="${valueOf(type)}"/>
                    <update-parameter value="${valueOf(desc)}"/>
                    <update-parameter value="${valueOf(uri)}"/>
                    <update-parameter value="${valueOf(name)}"/>
                    
                    <insert-parameter value="${valueOf(type)}"/>
                    <insert-parameter value="${valueOf(desc)}"/>
                    <insert-parameter value="${valueOf(uri)}"/>
                    <insert-parameter value="${valueOf(name)}"/>
                    <insert-parameter value="${org.jasig.portal.io.SequenceGeneratorPhrase(UP_CHAN_TYPE)}"/>
                </sql-upsert>
            </sql-transaction>
        </subtasks>
    </groovy>
</with-attribute>