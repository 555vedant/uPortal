<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd">
    
    <!--
     | Example Person Directory configuration using the Spring implementation.
	 |
	 | The 'username' attribute is what is configured by default in the code
	 | for simple string queries via the IPersonAttributeDao interfaces
	 +-->
     
    <bean id="personAttributeDao" class="org.jasig.portal.portlets.swapper.OverwritingPersonAttributeDao">
        <property name="delegatePersonAttributeDao" ref="cachingPersonAttributeDao" />
    </bean>

    <bean id="cachingPersonAttributeDao" class="org.jasig.services.persondir.support.CachingPersonAttributeDaoImpl">
        <property name="userInfoCache">
            <bean class="org.jasig.portal.utils.cache.MapCacheFactoryBean">
                <property name="cacheFactory" ref="cacheFactory" />
                <property name="cacheName" value="org.jasig.services.persondir.USER_INFO" />
            </bean>
        </property>
        <property name="cachedPersonAttributesDao" ref="mergedPersonAttributeDao" />
    </bean>
  
	<bean id="mergedPersonAttributeDao" class="org.jasig.services.persondir.support.MergingPersonAttributeDaoImpl">
		<property name="personAttributeDaos">
			<list>
				<ref bean="uPortalJdbcAttributeSource"/>
			</list>
		</property>
	</bean>


	<!-- JDBC Person Attribute Source, using the default portal DataSource -->
	<bean id="uPortalJdbcAttributeSource" class="org.jasig.services.persondir.support.jdbc.SingleRowJdbcPersonAttributeDao">
		<constructor-arg index="0" ref="PersonDB" />
		<constructor-arg>
            <!-- Double single quotes required since SQL is run through a MessageFormat when adding in the generated portion of the where clause -->
			<value>	
				SELECT FIRST_NAME||' '||LAST_NAME AS FIRST_LAST, FIRST_NAME, LAST_NAME, EMAIL, USER_NAME 
				FROM UP_PERSON_DIR 
				WHERE {0}
			</value>
		</constructor-arg>
        <!-- Allow for querying using any field in the table -->
        <property name="queryAttributeMapping">
            <map>
                <entry key="username" value="USER_NAME" />
                <entry key="user.name.family" value="LAST_NAME" />
                <entry key="user.name.given" value="FIRST_NAME" />
                <entry key="user.home-info.online.email" value="EMAIL" />
            </map>
        </property>
        <!-- Map the table fields to P3P and LDAP attribute names -->
		<property name="resultAttributeMapping">
			<map>
				<entry key="FIRST_LAST" value="displayName" />
				<entry key="FIRST_NAME">
					<set>
						<value>givenName</value>
						<value>user.name.given</value>
					</set>
				</entry>
				<entry key="LAST_NAME">
					<set>
						<value>sn</value>
						<value>user.name.family</value>
					</set>
				</entry>
				<entry key="EMAIL">
					<set>
						<value>mail</value>
						<value>user.home-info.online.email</value>
					</set>
				</entry>
				<entry key="USER_NAME">
                    <set>
                        <value>username</value>
                        <value>user.login.id</value>
                    </set>
                </entry>
			</map>
		</property>
	</bean>
</beans>
