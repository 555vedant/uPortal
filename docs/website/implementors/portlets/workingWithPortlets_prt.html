<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="content-type">
  <title>Guide to Working with Portlets in uPortal</title>
</head>
<body>
<h1 style="text-align: center;">Guide to Working with Portlets in
uPortal<br>
</h1>
<h2>Contents</h2>
<a href="#Introduction">Introduction</a><br>
<a href="#Servlet_Container_Issues">Servlet Container Issues</a><br>
<a href="#Sample_Portlets">Sample Portlets</a><br>
<a href="#Deploying_Portlets">Deploying Portlets</a><br>
<a href="#Publishing_Portlets">Publishing Portlets</a><br>
<a href="#Portlet_Caching">Portlet Caching</a><br>
<a href="#User_Information">User Information</a><br>
<a href="#Portlet_Security">Portlet Security</a><br>
<a
 href="file:///C:/Projects/JA-SIG/uPortal/docs/website/implementors/portlets/workingWithPortlets.html#Custom_Portlet_Modes_and_Window_States">Custom
Portlet Modes and Window States</a><br>
<a href="#Future_of_Portlets_in_uPortal">Future of Portlets in uPortal</a><br>
<h2><a name="Introduction"></a>Introduction</h2>
uPortal is committed to supporting open standards including the <a
 href="http://www.jcp.org/en/jsr/detail?id=168">Java Portlet
Specification</a>, initially known as
JSR 168.&nbsp; Portlets are designed to be the basic building block of
a Portal.&nbsp; The uPortal analog to a Portlet has thus far been the
Channel which is based on the <code>org.jasig.portal.IChannel</code>
java
interface.&nbsp; To provide a runtime environment for Portlets, uPortal
has chosen to use a Portlet Container from the Apache Jakarta project
called <a href="http://jakarta.apache.org/pluto/">Pluto</a>.&nbsp;
Pluto is the reference implementation of the Java Portlet
Specification.&nbsp; Beginning with uPortal 2.3, uPortal embeds the
Pluto container and
includes a Portlet adapter that makes it possible to install
and render Portlets along with its native Channels.&nbsp; The End-User
of uPortal can not tell the difference between a Portlet and a Channel.
<br>
<br>
Pluto, when downloaded separately from Apache, is distributed with
several components:<br>
<ul>
  <li>Portlet API (JSR-168)</li>
  <li>Portlet Container</li>
  <li>Portal Driver</li>
  <li>Test Suite Portlet</li>
</ul>
uPortal includes the Portlet API, Portlet Container, and Test Suite
Portlet, but not Pluto's Portal Driver which is not meant to be a fully
functional portal.&nbsp; uPortal acts as the Portal Driver.&nbsp; This
guide gives you an overview of the uPortal Portlet environment.<br>
<h2><a name="Servlet_Container_Issues"></a>Servlet Container Issues</h2>
uPortal, with its implementation of Pluto, requires that the web
application context representing the deployed portal web application be
set as "cross context" because Pluto dispatches the Portlet request
objects to the individual Portlet applications which run in their own
web application context.&nbsp; Each servlet container should provide a
means to enable this "cross context" setting.&nbsp; It can be
accomplished in the Tomcat&nbsp; servlet container in the following
ways:<br>
<ol>
  <li>For Tomcat 5, you can include an XML file in the <code>conf/Catalina/{hostname}</code>
directory that contains the <code>&lt;Context&gt;</code> element
definition.&nbsp; uPortal 2.3 automatically deploys such a file <code>properties/uPortal.xml</code>
to <code>conf/Catalina/localhost/uPortal.xml</code>.&nbsp; This, of
course, assumes that your context name is <code>uPortal</code> and
your hostname is <code>localhost</code>.</li>
  <li>For Tomcat 4, you can include a similar XML file in the <code>webapps</code>
directory.</li>
  <li>For either Tomcat 4 or 5, you can alternatively edit the <code>conf/server.xml</code>
file, adding a <code>&lt;Context&gt;</code> element for your portal
application with the <code>crossContext</code> attribute set to true:<code><br>
&lt;Context path="/uPortal" docBase="uPortal" crossContext="true"&gt;<br>
&lt;/Context&gt;</code></li>
</ol>
<strong>Note: uPortal will not be able to run Portlets in Tomcat
5.0.19 because of a Tomcat bug that is documented <a
 href="http://nagoya.apache.org/bugzilla/show_bug.cgi?id=27309">here</a>.<br>
<span style="font-weight: bold;"></span></strong>
<h2><a name="Sample_Portlets"></a>Sample Portlets</h2>
uPortal comes with 3 sample Portlets that are preinstalled: <br>
<ol>
  <li>Test Suite Portlet - comes with Pluto [<a
 href="http://jakarta.apache.org/pluto/multiproject/testsuite/">Info</a>]<br>
  </li>
  <li>RSS Portlet - comes from <a
 href="http://portlet-opensrc.sourceforge.net/">Portlet Open Source
Trading Site (POST)</a> [<a
 href="http://prdownloads.sourceforge.net/portlet-opensrc/RssPortlet.zip?download">Download</a>]<br>
  </li>
  <li>Google Portlet - comes from <a
 href="http://portlet-opensrc.sourceforge.net/">Portlet Open Source
Trading Site (POST)</a> [<a
 href="http://prdownloads.sourceforge.net/portlet-opensrc/GooglePortlet.zip?download">Download</a>]<br>
  </li>
</ol>
To use these Portlets, log into uPortal with user name and password
demo/demo and navigate to the tab called Portlet Examples.&nbsp; You
should see 2 instances of the Test Suite Portlet in the first and
second columns and the RSS and Google Portlets in the third
column.&nbsp; The Test Suite Portlet tests the Portal Driver's
implementation of the Portlet Container.&nbsp; The RSS Portlet and
Google Portlet are just Portlet examples and were contributed to POST
by <a href="http://www.plumtree.com/">Plumtree Software</a>.<br>
<br>
Note: The Google Portlet will not be fully functional until you
configure a license key in the <code>&lt;init-param&gt;</code> element
of Google Portlet's <code>portlet.xml</code> file.&nbsp; To obtain a
license key, visit <a href="http://www.google.com/apis/">Google Web
APIs</a> and follow instructions to set up an account.&nbsp; Once you
have the license key, unzip the <code>GooglePortlet.war</code> file,
modify
the <code>WEB-INF/portlet.xml</code> file, and then zip it all up
again.
<h2><a name="Deploying_Portlets"></a>Deploying Portlets</h2>
The sample portlets mentioned above were all deployed as part of
uPortal's <code>initportal</code> ant target.&nbsp; The ant target
subtask of <code>initportal</code> that performs the deployment of
Portlet Applications is <code>deployPortletApp</code>.&nbsp; The <code>deployPortletApp</code>
target runs the portlet deployer tool, <code>org.jasig.portal.container.deploy.Deployer</code>.
This tool takes a Portlet WAR file, rewrites the <code>web.xml</code>
file (a requirement of the Pluto Portlet Container), and deploys the
results to the servlet container.&nbsp; You can deploy multiple
portlets at once by placing them in uPortal's <code>lib/portlets</code>
directory and specifying <code>all</code> as the porletApp.&nbsp; For
example:<br>
&nbsp; <br>
<code>&nbsp;&nbsp;&nbsp; ant deployPortletApp -DportletApp=all<br>
</code><br>
You can also deploy one Portlet application at a time by specifying the
location of the Portlet application WAR file:<code><br>
<br>
&nbsp;&nbsp;&nbsp; ant deployPortletApp
-DportletApp=C:/TEMP/myPortlet.war</code><br>
<h2><a name="Publishing_Portlets"></a>Publishing Portlets</h2>
uPortal will build a Portlet Registry based on all the Portlets that
are deployed into the servlet container.&nbsp; It does this by
examining all the installed web applications, looking for the ones that
contain a <code>portlet.xml</code> file, and parsing that <code>portlet.xml</code>
file to find out what Portlet Application Definitions and Portlet
Defiinitions are available.<br>
<br>
To publish a Portlet in uPortal, you need to know the Portlet
Definition ID and any necessary parameters.&nbsp; The Portlet
Definition ID is in the form of <code>[portlet-context-name].[portlet-name]</code>.&nbsp;
For example, for the Pluto Test Suite Portlet, the application was
bundled as <code>testsuite.war</code> and the Portlet name from <code>portal.xml</code>
was <code>TestPortlet1</code>.&nbsp; Therefore the Portlet Definition
ID for this Portlet would be <code>testsuite.TestPortlet1</code>.<br>
<br>
Once you know the Portlet Definition ID, you can publish the Portlet
either via the Channel Manager publishing GUI or by creating a channel
definition XML file and placing it in uPortal's <code>properties/chanpub</code>
directory.&nbsp; That directory already contains sample channel
definition XML files for the 3 included sample Portlets that are
described above.&nbsp; If you choose to publish the Portlet using the
GUI, select the Portlet channel type and follow instructions to enter
the required parameters.&nbsp; In both cases, you are actually
publishing a Portlet adapter which knows how to find and
render the appropriate Portlet based on the Portlet Definition ID.<br>
<h2><a name="Portlet_Caching"></a>Portlet Caching</h2>
In order to make the Portlet adapter as efficient as
possible, a caching strategy was implemented that is beyond the scope
of the Portlet's control.&nbsp; It works as follows:&nbsp; uPortal will
cache the contents of a Portlet screen until one of the following
occurs:<br>
<ul>
  <li>The user clicks on a link or button within the Portlet.</li>
  <li>The user clicks on a button within the Portlet control bar, i.e.
Edit, Help, About, etc.</li>
  <li>The Portlet is focused or unfocused, i.e. the Portlet alternates
between being the root of the layout and not the root of the layout.</li>
  <li>A PortalEvent is sent to the Portlet.</li>
</ul>
When one of these activities occurs, it usually triggers a state change
within the Portlet, and the new screen is cached until one of these
activities happens again.&nbsp; Therefore, simply clicking refresh on
your browser will not cause the Portlet to render itself again.&nbsp;
The optional Portlet caching settings mentioned in the Portlet
Specification are not implemented at this time.<br>
<h2><a name="User_Information"></a>User Information</h2>
As of uPortal 2.3.2, you will be able to access a user
attribute with the following code: <br>
<pre wrap=""><code>Map userInfo = (Map)request.getAttribute(PortletRequest.USER_INFO);<br>String givenName = (String)userInfo.get("user.name.given");<br>String lastName = (String)userInfo.get("user.name.last");<br></code></pre>
The Portlet Specification says that you should be able to map user
attribute names declared in the <code>portlet.xml</code> file at
deployment
time.&nbsp;
In uPortal, this feature will not be available.&nbsp; Instead, you
will
have to edit uPortal's <code>PersonDirs.xml</code> file, adding
aliases for any of the user attribute names declared in the <code>portlet.xml</code>
file that don't already exist in <code>PersonDirs.xml</code>.&nbsp;
Only the attributes defined in <code>portlet.xml</code> will be
accessible to your
portlet.&nbsp; For example, if your <code>portlet.xml</code> file
contains...<br>
<br>
<code>&lt;user-attribute&gt;<br>
&nbsp;&nbsp;&nbsp; &lt;description&gt;User Given
Name&lt;/description&gt;<br>
&nbsp;&nbsp;&nbsp; &lt;name&gt;user.name.given&lt;/name&gt;<br>
&lt;/user-attribute&gt;<br>
<br>
</code>...then your <code>PersonDirs.xml </code>will need to
contain something like...<br>
<br>
&nbsp;<code>&lt;attribute&gt;<br>
</code><code>&nbsp;&nbsp;&nbsp;
&lt;name&gt;FIRST_NAME&lt;/name&gt;<br>
</code><code>&nbsp;&nbsp;&nbsp; &lt;alias&gt;</code><code>user.name.given</code><code>&lt;/alias&gt;<br>
&lt;/attribute&gt;<br>
<br>
</code>As of uPortal 2.4, Portlets can be configured to receive the
user's password as a user attribute.&nbsp; If this is desired, simply
include the following user attribute mapping in <code>portlet.xml</code>:<br>
<br>
<code>&lt;user-attribute&gt;<br>
&nbsp;&nbsp;&nbsp; &lt;description&gt;User Password&lt;/description&gt;<br>
&nbsp;&nbsp;&nbsp; &lt;name&gt;password&lt;/name&gt;<br>
&lt;/user-attribute&gt;<br>
<br>
</code>If a password mapping was specified in <code>PersonDirs.xml</code>,
then it will be used.&nbsp; Otherwise, uPortal will look for the
password in the user's authenticated security contexts that cache
credentials, using the first one it finds.<br>
<br>
Full support of deployment-time mapping will be
available in
uPortal 3.0.<br>
<h2><span style="font-weight: bold;"><a name="Portlet_Security"></a></span>Portlet
Security</h2>
As of uPortal 2.4, Portlets in uPortal can make use of the <code>getRemoteUser()</code>,
<code>getUserPrincipal()</code>, and <code>isUserInRole()</code>
methods of the <code>PortletRequest</code>.&nbsp; <br>
<br>
Each method will first try to call its respective method on the
original servlet request to see if the information is available (it
would be available if J2EE security was properly set up in the
container and the container has authenticated the user).&nbsp; If not,
then it will use uPortal's IPerson object in conjunction with uPortal's
GroupService to determine the answers.&nbsp; The role mapping that must
be included with the <code>portlet.xml</code> will be a mapping from
some made-up role to a uPortal Groups key.&nbsp; For example: <br>
<br>
<code>&lt;security-role-ref&gt;<br>
&nbsp;&nbsp;&nbsp; &lt;role-name&gt;myEveryoneRole&lt;/role-name&gt;<br>
&nbsp;&nbsp;&nbsp; &lt;role-link&gt;local.0&lt;/role-link&gt;<br>
&lt;/security-role-ref&gt;</code><br>
<br>
<code>&lt;security-role-ref&gt;<br>
&nbsp;&nbsp;&nbsp; &lt;role-name&gt;myStudentRole&lt;/role-name&gt;<br>
&nbsp;&nbsp;&nbsp; &lt;role-link&gt;pags.students&lt;/role-link&gt;<br>
&lt;/security-role-ref&gt;<br>
<br>
</code>If these example mappings were included and the user was
authenticated and in the <code>pags.students</code> role, then a call
from within the Portlet to <code>portletRequest.isUserInRole("myStudentRole")</code>
and <code>portletRequest.isUserInRole("pags.students")</code> should
return <code>true</code>.<br>
<br>
Note that security tests included with Pluto's <code>testsuite</code>
Portlet test for a role mapped to the role link of <code>tomcat</code>
which isn't a valid role within uPortal.&nbsp; Therefore, some of these
tests will fail until Pluto makes their tests more flexible by
providing a properties file that lets us specify the role link
ourselves.<br>
<code></code>
<h2><a name="Custom_Portlet_Modes_and_Window_States"></a>Custom Portlet
Modes and Window States</h2>
uPortal supports the following Portlet modes:<br>
<ul>
  <li>VIEW</li>
  <li>EDIT</li>
  <li>HELP</li>
</ul>
When a user clicks on one of these buttons in the channel control bar,
the Portlet mode will change.&nbsp; There is currently no button
provided to
switch the mode back to the default VIEW mode.&nbsp; At this time,
custom
Portlet modes are not supported. <br>
<br>
uPortal supports the following Portlet window states: <br>
<ul>
  <li>NORMAL - Portlet is rendered along with other Portlets in the
layout.<br>
  </li>
  <li>MAXIMIZED - Same as uPortal focused concept.<br>
  </li>
  <li>MINIMIZED - Same as uPortal minimized concept.</li>
  <li>EXCLUSIVE - Gives Portlet full control over request and
response.&nbsp; Can be used to achieve file downloading.<br>
  </li>
</ul>
<pre wrap=""><code></code><code></code></pre>
<pre wrap=""><code></code><code></code></pre>
<h2><a name="Future_of_Portlets_in_uPortal"></a>Future of Portlets in
uPortal</h2>
uPortal 3.0 will continue to support Portlets using the Pluto Portlet
Container.&nbsp; The Portlet will eventually replace the Channel as the
primary portal module.&nbsp; This means that terminology within uPortal
will change to reflect the use of Portlets rather than Channels.&nbsp;
Also the rendering architecture of uPortal will be simplified to handle
the Portlet natively, rather than through an adapter.&nbsp; The
Channel, of course, will still be supported though a Channel
adapter.&nbsp; uPortal 3.0 is still in its early design stages.&nbsp;
More will be added to this section as the design matures.<br>
<br>
<br>
</body>
</html>
